<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªôi Tr·∫°i Xu√¢n 2026 - THPT S·ªë 1 Tr·∫ßn Ph√∫</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; display: flex; flex-direction: column; min-height: 95vh; }
        .school-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .school-name { font-size: 1.2rem; color: #555; font-weight: bold; letter-spacing: 1px; margin: 0; }
        .camp-name { font-size: 2.2rem; color: #d32f2f; font-weight: 900; margin: 5px 0 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .clock-container { text-align: center; background: #2c3e50; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 20px; width: fit-content; margin-left: auto; margin-right: auto; }
        .time-display { font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        .mode-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; background: #e0e0e0; padding: 5px; border-radius: 30px; width: fit-content; margin-left: auto; margin-right: auto; }
        .btn-mode { padding: 10px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s; color: #555; background: transparent; }
        .btn-mode.active-guest { background-color: #3498db; color: white; }
        .btn-mode.active-admin { background-color: #e74c3c; color: white; }
        #adminPanel { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .admin-grid { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .filter-panel { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #d32f2f; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        select, input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .btn-export { background-color: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-toggle { background-color: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .stats { display: flex; justify-content: space-around; background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-number { font-size: 1.4rem; display: block; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #d32f2f; color: white; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; width: 80px; display: inline-block; text-align: center; }
        .bg-present { background-color: #d1fae5; color: #065f46; }
        .bg-absent { background-color: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
        .toast-msg { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; font-weight: bold; animation: slideIn 0.5s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .footer { margin-top: 40px; text-align: center; color: #7f8c8d; font-size: 0.9rem; padding-bottom: 20px;}
    </style>
</head>
<body>

    <div class="school-header">
        <h3 class="school-name">Tr∆∞·ªùng THPT S·ªë 1 Tr·∫ßn Ph√∫</h3>
        <h1 class="camp-name">H·ªòI TR·∫†I XU√ÇN 2026</h1>
    </div>

    <div class="clock-container">
        <div id="liveTime" class="time-display">00:00:00</div>
        <div id="liveDate" class="date-display">...</div>
    </div>

    <div class="mode-container">
        <button id="btnGuest" class="btn-mode active-guest">üëÄ Ch·∫ø ƒë·ªô Kh√°ch</button>
        <button id="btnAdmin" class="btn-mode">üõ°Ô∏è Ch·∫ø ƒë·ªô Qu·∫£n l√Ω</button>
    </div>

    <div id="adminPanel" class="hidden">
        <div id="superAdminOnly" class="hidden">
            <h4 style="margin: 0 0 10px 0;">C√†i ƒë·∫∑t h·ªá th·ªëng (Admin)</h4>
            <div class="admin-grid" style="margin-bottom: 15px;">
                <input type="text" id="newAccUser" placeholder="T√™n l·ªõp (10A1) ho·∫∑c 'cong1'">
                <input type="text" id="newAccPass" placeholder="M√£ xxxx">
                <button class="btn-toggle" onclick="createAccount()">T·∫°o Acc</button>
                <button class="btn-export" style="background:#34495e" onclick="downloadSampleExcel()">üìÑ File M·∫´u</button>
                <button class="btn-export" style="background:#8e44ad" onclick="document.getElementById('importExcel').click()">üì§ Import Excel</button>
                <input type="file" id="importExcel" hidden accept=".xlsx, .xls" onchange="handleImportExcel(event)">
            </div>
        </div>
        <div class="admin-grid">
            <span id="currentLoginInfo" style="font-weight: bold; color: #d32f2f;"></span>
            <input type="text" id="changePassInput" placeholder="M√£ xxxx m·ªõi">
            <button class="btn-toggle" style="background:#27ae60" onclick="changeMyPass()">ƒê·ªïi m√£ s·ªë</button>
        </div>
    </div>

    <div class="filter-panel">
        <span style="font-weight:bold">üîç T√åM KI·∫æM:</span>
        <input type="text" id="searchInput" placeholder="T√™n ho·∫∑c vi·∫øt t·∫Øt (nva)...">
        <select id="filterClass"><option value="all">-- L·ªõp --</option></select>
        <select id="filterStatus">
            <option value="all">-- Tr·∫°ng th√°i --</option>
            <option value="present">C√≥ m·∫∑t</option>
            <option value="absent">V·∫Øng</option>
        </select>
        <button class="btn-export" id="btnExport">üì• Xu·∫•t Excel</button>
    </div>

    <div class="stats">
        <div style="text-align:center">T·ªîNG C·ªòNG <span id="statTotal" class="stat-number" style="color:#f1c40f">0</span></div>
        <div style="text-align:center">C√ì M·∫∂T <span id="statPresent" class="stat-number" style="color:#2ecc71">0</span></div>
        <div style="text-align:center">V·∫ÆNG <span id="statAbsent" class="stat-number" style="color:#ff6b6b">0</span></div>
    </div>

    <div style="overflow-x:auto">
        <table>
            <thead>
                <tr>
                    <th>STT</th><th>L·ªõp</th><th>H·ªç v√† T√™n</th><th>Tr·∫°ng Th√°i</th><th>C·∫≠p nh·∫≠t</th>
                    <th id="colAction" class="hidden">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="footer">
        ¬© 2026 - Ph√°t tri·ªÉn b·ªüi: <strong>Tr·∫ßn H·ªìng D√¢n</strong>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEnDE2pOyfKZYUPCSXgaHaR2b9h_AjAe8",
            authDomain: "hoitrai2026.firebaseapp.com",
            databaseURL: "https://hoitrai2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hoitrai2026",
            storageBucket: "hoitrai2026.firebasestorage.app",
            messagingSenderId: "648028043852",
            appId: "1:648028043852:web:9d0b07f6823fcec5fa12e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const SYSTEM_PASSWORD = "11043006";

        let globalStudents = [];
        let isAdmin = false;
        let currentUser = null;

        // --- H√ÄM TI·ªÜN √çCH ---
        function removeVietnameseTones(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D').toLowerCase();
        }

        function getInitials(name) {
            return removeVietnameseTones(name).split(' ').map(w => w[0]).join('');
        }

        function showToast(msg) {
            const t = document.createElement("div"); t.className = "toast-msg"; t.textContent = `‚úÖ ${msg}`;
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
        }

        // --- D·ªÆ LI·ªÜU FIREBASE ---
        onValue(ref(db, 'students'), (snap) => {
            const data = snap.val();
            globalStudents = data ? Object.values(data) : [];
            initClassFilter();
            renderTable();
        });

        // --- ƒêƒÇNG NH·∫¨P ---
        document.getElementById('btnAdmin').addEventListener('click', () => {
            if (isAdmin) return;
            const pass = prompt("üîë M·∫≠t kh·∫©u (L·ªõp+xxxx ho·∫∑c cong+xxxx):");
            if (!pass) return;

            if (pass === SYSTEM_PASSWORD) {
                isAdmin = true; currentUser = { id: 'admin', type: 'super', target: 'all' };
                updateUIMode(); return;
            }

            onValue(ref(db, 'accounts'), (snap) => {
                const accs = snap.val();
                let found = false;
                const lowPass = pass.toLowerCase();
                for (let id in accs) {
                    if (accs[id].password.toLowerCase() === lowPass) {
                        isAdmin = true; currentUser = accs[id]; found = true; break;
                    }
                }
                found ? updateUIMode() : alert("Sai m·∫≠t kh·∫©u!");
            }, { onlyOnce: true });
        });

        document.getElementById('btnGuest').addEventListener('click', () => {
            isAdmin = false; currentUser = null; updateUIMode();
        });

        function updateUIMode() {
            const panel = document.getElementById("adminPanel");
            const superZone = document.getElementById("superAdminOnly");
            const btnA = document.getElementById("btnAdmin");
            const btnG = document.getElementById("btnGuest");
            
            if (isAdmin) {
                panel.classList.remove("hidden");
                btnA.classList.add("active-admin"); btnG.classList.remove("active-guest");
                document.getElementById("currentLoginInfo").textContent = `Ch√†o: ${currentUser.id}`;
                currentUser.type === 'super' ? superZone.classList.remove("hidden") : superZone.classList.add("hidden");
                document.getElementById("colAction").classList.remove("hidden");
            } else {
                panel.classList.add("hidden");
                btnA.classList.remove("active-admin"); btnG.classList.add("active-guest");
                document.getElementById("colAction").classList.add("hidden");
            }
            renderTable();
        }

        // --- QU·∫¢N L√ù ACC ---
        window.createAccount = function() {
            const user = document.getElementById('newAccUser').value.trim();
            const pin = document.getElementById('newAccPass').value.trim();
            if (!user || !pin) return;
            
            // X·ª≠ l√Ω Target lu√¥n vi·∫øt hoa n·∫øu l√† l·ªõp
            const type = user.toLowerCase().startsWith('cong') ? 'gate' : 'class';
            const finalTarget = type === 'class' ? user.toUpperCase() : 'all';
            
            const acc = { id: user, password: user + pin, type: type, target: finalTarget };
            update(ref(db, 'accounts/' + user), acc).then(() => showToast("ƒê√£ t·∫°o " + user));
        };

        window.changeMyPass = function() {
            const pin = document.getElementById('changePassInput').value.trim();
            if (pin.length < 4 || !currentUser || currentUser.id === 'admin') return alert("Kh√¥ng h·ª£p l·ªá");
            const newP = currentUser.id + pin;
            update(ref(db, 'accounts/' + currentUser.id), { password: newP }).then(() => {
                showToast("ƒê·ªïi m√£ th√†nh c√¥ng!");
                currentUser.password = newP;
            });
        };

        // --- EXCEL ---
        window.downloadSampleExcel = function() {
            const data = [["ID_TaiKhoan", "Ma_PIN"], ["10a01", "1234"], ["cong01", "0000"]];
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mau"); XLSX.writeFile(wb, "Mau_Tai_Khoan.xlsx");
        };

        window.handleImportExcel = function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const updates = {}; let count = 0;
                
                json.forEach(row => {
                    const u = String(row.ID_TaiKhoan || "").trim(); 
                    const p = String(row.Ma_PIN || "").trim();
                    if (u && p) {
                        const type = u.toLowerCase().startsWith('cong') ? 'gate' : 'class';
                        // S·ª≠a l·ªói: N·∫øu l√† l·ªõp, target ph·∫£i VI·∫æT HOA ƒë·ªÉ kh·ªõp v·ªõi d·ªØ li·ªáu h·ªçc sinh
                        const target = type === 'class' ? u.toUpperCase() : 'all';
                        
                        updates['accounts/' + u] = { 
                            id: u, 
                            password: u + p, 
                            type: type, 
                            target: target 
                        };
                        count++;
                    }
                });
                if(count > 0) {
                    update(ref(db), updates).then(() => {
                        showToast(`ƒê√£ import ${count} acc th√†nh c√¥ng!`);
                        setTimeout(() => location.reload(), 1500);
                    });
                } else { alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá!"); }
            };
            reader.readAsArrayBuffer(file);
        };

        // --- HI·ªÇN TH·ªä B·∫¢NG ---
        function renderTable() {
            const tbody = document.getElementById("tableBody");
            const fSearch = removeVietnameseTones(document.getElementById("searchInput").value);
            let fClass = document.getElementById("filterClass").value;
            const fStatus = document.getElementById("filterStatus").value;

            // R√†ng bu·ªôc l·ªõp d·ª±a tr√™n t√†i kho·∫£n
            if (isAdmin && currentUser.type === 'class') {
                fClass = currentUser.target; // Lu√¥n l√† ch·ªØ hoa nh·ªù x·ª≠ l√Ω l√∫c t·∫°o acc
                document.getElementById("filterClass").value = fClass;
                document.getElementById("filterClass").disabled = true;
            } else {
                document.getElementById("filterClass").disabled = false;
            }

            tbody.innerHTML = "";
            let sTotal = 0, sPresent = 0, sAbsent = 0;

            const sorted = [...globalStudents].sort((a,b) => a.class.localeCompare(b.class));
            sorted.forEach(s => {
                const matchClass = (fClass === 'all' || s.class.toUpperCase() === fClass.toUpperCase());
                const matchStatus = (fStatus === 'all' || s.status === fStatus);
                const matchSearch = !fSearch || removeVietnameseTones(s.name).includes(fSearch) || getInitials(s.name).includes(fSearch);

                if (matchClass && matchStatus && matchSearch) {
                    sTotal++;
                    s.status === 'present' ? sPresent++ : sAbsent++;

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${sTotal}</td>
                        <td><b>${s.class}</b></td>
                        <td>${s.name}</td>
                        <td><span class="badge ${s.status === 'present' ? 'bg-present' : 'bg-absent'}">${s.status === 'present' ? 'C√ì M·∫∂T' : 'V·∫ÆNG'}</span></td>
                        <td style="font-size:0.8rem">${s.lastUpdated || '-'}</td>
                        ${isAdmin ? `<td><button class="btn-toggle" onclick="toggleStatus(${s.id})">ƒê·ªïi</button></td>` : ''}
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.getElementById("statTotal").textContent = sTotal;
            document.getElementById("statPresent").textContent = sPresent;
            document.getElementById("statAbsent").textContent = sAbsent;
        }

        window.toggleStatus = function(id) {
            const s = globalStudents.find(x => x.id === id);
            if (!s) return;
            const newS = s.status === 'present' ? 'absent' : 'present';
            const now = new Date();
            const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} - ${now.getDate()}/${now.getMonth()+1}`;
            update(ref(db, 'students/' + id), { status: newS, lastUpdated: time });
        };

        function initClassFilter() {
            const sel = document.getElementById("filterClass");
            const classes = [...new Set(globalStudents.map(s => s.class))].sort();
            if (sel.options.length <= 1) {
                classes.forEach(c => { const o = new Option(c, c); sel.add(o); });
            }
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterClass').addEventListener('change', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);
        
        setInterval(() => {
            const now = new Date();
            document.getElementById('liveTime').textContent = now.toLocaleTimeString('vi-VN');
            document.getElementById('liveDate').textContent = now.toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'long'});
        }, 1000);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªôi Tr·∫°i Xu√¢n 2026 - THPT S·ªë 1 Tr·∫ßn Ph√∫</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; color: #333; }
        .school-header { text-align: center; margin-bottom: 20px; }
        .school-name { font-size: 1.1rem; color: #666; font-weight: bold; margin: 0; text-transform: uppercase; }
        .camp-name { font-size: 2.2rem; color: #d32f2f; font-weight: 900; margin: 5px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .clock-container { text-align: center; background: #2c3e50; color: #fff; padding: 10px; border-radius: 8px; margin: 0 auto 20px auto; width: fit-content; min-width: 200px; }
        .time-display { font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        
        .mode-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .btn-mode { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s; background: #e0e0e0; }
        .btn-mode.active-guest { background-color: #3498db; color: white; }
        .btn-mode.active-admin { background-color: #e74c3c; color: white; }

        /* Admin & Filter Panels */
        #adminPanel, .filter-panel { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #adminPanel { border-left: 5px solid #e74c3c; }
        .filter-panel { border-left: 5px solid #d32f2f; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .btn-toggle { background-color: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-export { background-color: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Stats */
        .stats { display: flex; justify-content: space-around; background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.5rem; display: block; font-weight: bold; }

        /* Table */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #d32f2f; color: white; white-space: nowrap; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; display: inline-block; width: 70px; text-align: center; }
        .bg-present { background-color: #d1fae5; color: #065f46; }
        .bg-absent { background-color: #fee2e2; color: #991b1b; }

        .hidden { display: none; }
        .toast-msg { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 25px; border-radius: 8px; z-index: 9999; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .footer { margin-top: 30px; text-align: center; color: #888; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 20px; }
    </style>
</head>
<body>

    <div class="school-header">
        <h3 class="school-name">Tr∆∞·ªùng THPT S·ªë 1 Tr·∫ßn Ph√∫</h3>
        <h1 class="camp-name">H·ªòI TR·∫†I XU√ÇN 2026</h1>
    </div>

    <div class="clock-container">
        <div id="liveTime" class="time-display">00:00:00</div>
        <div id="liveDate" style="font-size: 0.8rem; color: #bdc3c7;">...</div>
    </div>

    <div class="mode-container">
        <button id="btnGuest" class="btn-mode active-guest">üëÄ Kh√°ch</button>
        <button id="btnAdmin" class="btn-mode">üõ°Ô∏è Qu·∫£n l√Ω</button>
    </div>

    <div id="adminPanel" class="hidden">
        <div id="superAdminOnly" class="hidden" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee;">
            <h4 style="margin: 0 0 10px 0;">H·ªá th·ªëng T√†i kho·∫£n (Super Admin)</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="newAccUser" placeholder="T√™n l·ªõp (10a1) ho·∫∑c 'cong1'">
                <input type="text" id="newAccPass" placeholder="M√£ PIN xxxx">
                <button class="btn-toggle" onclick="createAccount()">T·∫°o Acc</button>
                <button class="btn-export" style="background:#34495e" onclick="downloadSampleExcel()">üìÑ File M·∫´u</button>
                <button class="btn-export" style="background:#8e44ad" onclick="document.getElementById('importExcel').click()">üì§ Import Excel</button>
                <input type="file" id="importExcel" hidden accept=".xlsx, .xls" onchange="handleImportExcel(event)">
            </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <span id="currentLoginInfo" style="font-weight: bold; color: #d32f2f;"></span>
            <input type="text" id="changePassInput" placeholder="M√£ xxxx m·ªõi">
            <button class="btn-toggle" style="background:#27ae60" onclick="changeMyPass()">ƒê·ªïi m√£ s·ªë</button>
            <button class="btn-toggle" style="background:#7f8c8d" id="btnUploadData">‚¨ÜÔ∏è N·∫°p d·ªØ li·ªáu g·ªëc</button>
        </div>
    </div>

    <div class="filter-panel">
        <input type="text" id="searchInput" placeholder="T√¨m t√™n ho·∫∑c vi·∫øt t·∫Øt (nva)..." style="flex-grow: 1;">
        <select id="filterClass"><option value="all">-- T·∫•t c·∫£ L·ªõp --</option></select>
        <select id="filterStatus">
            <option value="all">-- Tr·∫°ng th√°i --</option>
            <option value="present">C√≥ m·∫∑t</option>
            <option value="absent">V·∫Øng</option>
        </select>
        <button class="btn-export" id="btnExport">üì• Xu·∫•t Excel</button>
    </div>

    <div class="stats">
        <div class="stat-item">T·ªîNG <span id="statTotal" class="stat-number" style="color:#f1c40f">0</span></div>
        <div class="stat-item">C√ì M·∫∂T <span id="statPresent" class="stat-number" style="color:#2ecc71">0</span></div>
        <div class="stat-item">V·∫ÆNG <span id="statAbsent" class="stat-number" style="color:#ff6b6b">0</span></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">STT</th>
                    <th style="width: 100px;">L·ªõp</th>
                    <th>H·ªç v√† T√™n</th>
                    <th style="width: 120px;">Tr·∫°ng Th√°i</th>
                    <th style="width: 150px;">C·∫≠p nh·∫≠t</th>
                    <th id="colAction" class="hidden" style="width: 100px;">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="footer">¬© 2026 - Ph√°t tri·ªÉn b·ªüi: <strong>Tr·∫ßn H·ªìng D√¢n</strong></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEnDE2pOyfKZYUPCSXgaHaR2b9h_AjAe8",
            authDomain: "hoitrai2026.firebaseapp.com",
            databaseURL: "https://hoitrai2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hoitrai2026",
            storageBucket: "hoitrai2026.firebasestorage.app",
            messagingSenderId: "648028043852",
            appId: "1:648028043852:web:9d0b07f6823fcec5fa12e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const MASTER_PASS = "123";

        let globalStudents = [];
        let isAdmin = false;
        let currentUser = null;

        // --- UTILS ---
        function removeTones(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D').toLowerCase();
        }

        function getInitials(name) {
            return removeTones(name).split(' ').map(w => w[0]).join('');
        }

        function showToast(msg) {
            const t = document.createElement("div"); t.className = "toast-msg"; t.textContent = `‚úÖ ${msg}`;
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
        }

        // --- CORE DATA ---
        onValue(ref(db, 'students'), (snap) => {
            const data = snap.val();
            globalStudents = data ? Object.values(data) : [];
            initClassSelect();
            renderTable();
        });

        // --- AUTH ---
        document.getElementById('btnAdmin').addEventListener('click', () => {
            if (isAdmin) return;
            const pass = prompt("üîë Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n l√Ω:");
            if (!pass) return;

            if (pass === MASTER_PASS) {
                isAdmin = true; currentUser = { id: 'admin', type: 'super', target: 'all' };
                updateUIMode(); return;
            }

            onValue(ref(db, 'accounts'), (snap) => {
                const accs = snap.val() || {};
                let found = false;
                for (let id in accs) {
                    if (accs[id].password === pass) {
                        isAdmin = true; currentUser = accs[id]; found = true; break;
                    }
                }
                found ? updateUIMode() : alert("Sai m·∫≠t kh·∫©u!");
            }, { onlyOnce: true });
        });

        document.getElementById('btnGuest').addEventListener('click', () => {
            isAdmin = false; currentUser = null; updateUIMode();
        });

        function updateUIMode() {
            document.getElementById("adminPanel").classList.toggle("hidden", !isAdmin);
            document.getElementById("colAction").classList.toggle("hidden", !isAdmin);
            document.getElementById("btnAdmin").classList.toggle("active-admin", isAdmin);
            document.getElementById("btnGuest").classList.toggle("active-guest", !isAdmin);
            
            if (isAdmin) {
                document.getElementById("currentLoginInfo").textContent = `Ch√†o: ${currentUser.id}`;
                document.getElementById("superAdminOnly").classList.toggle("hidden", currentUser.type !== 'super');
            }
            renderTable();
        }

        // --- ACCOUNT ACTIONS ---
        window.createAccount = function() {
            const u = document.getElementById('newAccUser').value.trim();
            const p = document.getElementById('newAccPass').value.trim();
            if (!u || !p) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
            const isGate = u.toLowerCase().startsWith('cong');
            const acc = { id: u, password: u + p, type: isGate ? 'gate' : 'class', target: isGate ? 'all' : u.toUpperCase() };
            update(ref(db, 'accounts/' + u), acc).then(() => showToast("ƒê√£ t·∫°o: " + u));
        };

        window.changeMyPass = function() {
            const pin = document.getElementById('changePassInput').value.trim();
            if (pin.length < 4 || !currentUser || currentUser.id === 'admin') return alert("M√£ PIN kh√¥ng h·ª£p l·ªá!");
            const newFullPass = currentUser.id + pin;
            update(ref(db, 'accounts/' + currentUser.id), { password: newFullPass }).then(() => {
                showToast("ƒê·ªïi m√£ PIN th√†nh c√¥ng!");
                currentUser.password = newFullPass;
            });
        };

        window.handleImportExcel = function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const updates = {}; let count = 0;
                data.forEach(row => {
                    const u = String(row.ID_TaiKhoan || "").trim();
                    const p = String(row.Ma_PIN || "").trim();
                    if (u && p) {
                        const isGate = u.toLowerCase().startsWith('cong');
                        updates['accounts/' + u] = { id: u, password: u + p, type: isGate ? 'gate' : 'class', target: isGate ? 'all' : u.toUpperCase() };
                        count++;
                    }
                });
                if(count > 0) update(ref(db), updates).then(() => { showToast("ƒê√£ import acc th√†nh c√¥ng!"); setTimeout(()=>location.reload(), 1500); });
            };
            reader.readAsArrayBuffer(file);
        };

        window.downloadSampleExcel = function() {
            const ws = XLSX.utils.aoa_to_sheet([["ID_TaiKhoan", "Ma_PIN"], ["10a01", "1234"], ["cong01", "9999"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mau");
            XLSX.writeFile(wb, "Mau_Tai_Khoan.xlsx");
        };

        // --- RENDER TABLE ---
        function renderTable() {
            const tbody = document.getElementById("tableBody");
            const search = removeTones(document.getElementById("searchInput").value);
            let fClass = document.getElementById("filterClass").value;
            const fStatus = document.getElementById("filterStatus").value;

            // Ph√¢n quy·ªÅn l·ªçc l·ªõp
            if (isAdmin && currentUser.type === 'class') {
                fClass = currentUser.target;
                document.getElementById("filterClass").value = fClass;
                document.getElementById("filterClass").disabled = true;
            } else {
                document.getElementById("filterClass").disabled = false;
            }

            tbody.innerHTML = "";
            let tTotal = 0, tPresent = 0, tAbsent = 0;

            globalStudents.sort((a,b) => a.class.localeCompare(b.class)).forEach(s => {
                const mClass = (fClass === 'all' || s.class.toUpperCase() === fClass.toUpperCase());
                const mStatus = (fStatus === 'all' || s.status === fStatus);
                const mSearch = !search || removeTones(s.name).includes(search) || getInitials(s.name).includes(search);

                if (mClass && mStatus && mSearch) {
                    tTotal++;
                    s.status === 'present' ? tPresent++ : tAbsent++;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${tTotal}</td>
                        <td><b>${s.class}</b></td>
                        <td>${s.name}</td>
                        <td><span class="badge ${s.status==='present'?'bg-present':'bg-absent'}">${s.status==='present'?'C√ì M·∫∂T':'V·∫ÆNG'}</span></td>
                        <td style="font-size:0.75rem; color:#888">${s.lastUpdated || '-'}</td>
                        ${isAdmin ? `<td><button class="btn-toggle" style="padding:4px 8px; font-size:0.8rem" onclick="toggleStatus(${s.id})">ƒê·ªïi</button></td>` : ''}
                    `;
                    tbody.appendChild(tr);
                }
            });
            document.getElementById("statTotal").textContent = tTotal;
            document.getElementById("statPresent").textContent = tPresent;
            document.getElementById("statAbsent").textContent = tAbsent;
        }

        window.toggleStatus = function(id) {
            const s = globalStudents.find(x => x.id === id);
            if (!s) return;
            const now = new Date();
            const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} - ${now.getDate()}/${now.getMonth()+1}`;
            update(ref(db, `students/${id}`), { status: s.status === 'present' ? 'absent' : 'present', lastUpdated: time });
        };

        // --- EXPORT EXCEL ---
        document.getElementById('btnExport').addEventListener('click', () => {
            let fClass = document.getElementById("filterClass").value;
            const fStatus = document.getElementById("filterStatus").value;
            const search = removeTones(document.getElementById("searchInput").value);
            
            if (isAdmin && currentUser.type === 'class') fClass = currentUser.target;

            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="UTF-8"></head><body>
                <h2 style="text-align:center">DANH S√ÅCH H·ªåC SINH - H·ªòI TR·∫†I XU√ÇN 2026</h2>
                <table border="1">
                <thead><tr style="background:#d32f2f;color:white"><th>STT</th><th>L·ªõp</th><th>H·ªç v√† T√™n</th><th>Tr·∫°ng Th√°i</th><th>C·∫≠p nh·∫≠t cu·ªëi</th></tr></thead><tbody>`;
            
            let count = 0;
            globalStudents.sort((a,b) => a.class.localeCompare(b.class)).forEach(s => {
                const mClass = (fClass === 'all' || s.class.toUpperCase() === fClass.toUpperCase());
                const mStatus = (fStatus === 'all' || s.status === fStatus);
                const mSearch = !search || removeTones(s.name).includes(search) || getInitials(s.name).includes(search);
                if (mClass && mStatus && mSearch) {
                    count++;
                    html += `<tr><td>${count}</td><td>${s.class}</td><td>${s.name}</td><td>${s.status==='present'?'C√≥ m·∫∑t':'V·∫Øng'}</td><td>${s.lastUpdated||''}</td></tr>`;
                }
            });
            html += `</tbody></table></body></html>`;
            const blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Danh_Sach_${fClass}.xls`; a.click();
        });

        function initClassSelect() {
            const sel = document.getElementById("filterClass");
            const classes = [...new Set(globalStudents.map(s => s.class))].sort();
            if (sel.options.length <= 1) classes.forEach(c => sel.add(new Option(c, c)));
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterClass').addEventListener('change', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);
        
        setInterval(() => {
            const n = new Date();
            document.getElementById('liveTime').textContent = n.toLocaleTimeString('vi-VN');
            document.getElementById('liveDate').textContent = n.toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'long'});
        }, 1000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quan Ly Hoi Trai 2026 - THPT So 1 Tran Phu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; display: flex; flex-direction: column; min-height: 95vh; }
        .school-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .school-name { font-size: 1.1rem; color: #555; font-weight: bold; margin: 0; }
        .camp-name { font-size: 2rem; color: #d32f2f; font-weight: 900; margin: 5px 0 10px 0; }
        
        .clock-container { text-align: center; background: #2c3e50; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 20px; width: fit-content; margin-left: auto; margin-right: auto; }
        .time-display { font-size: 1.4rem; font-weight: bold; font-family: monospace; }

        .mode-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .btn-mode { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.3s; background: #e0e0e0; }
        .active-admin { background-color: #e74c3c !important; color: white; }

        .filter-panel { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #d32f2f; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        
        .admin-controls { display: none; gap: 10px; border-left: 2px solid #ccc; padding-left: 15px; }
        .btn-action { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-action:hover { opacity: 0.8; }
        .bg-green { background-color: #27ae60; }
        .bg-blue { background-color: #2980b9; }
        .bg-dark { background-color: #34495e; }

        .stats { display: flex; justify-content: space-around; background: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-number { font-size: 1.4rem; font-weight: bold; display: block; }

        .table-container { overflow-x: auto; background: white; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #d32f2f; color: white; white-space: nowrap; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .bg-present { background: #d1fae5; color: #065f46; }
        .bg-absent { background: #fee2e2; color: #991b1b; }
        
        .hidden { display: none; }
        .footer { text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="school-header">
        <h3 class="school-name">Truong THPT So 1 Tran Phu</h3>
        <h1 class="camp-name">HOI TRAI XUAN 2026</h1>
    </div>

    <div class="clock-container">
        <div id="liveTime" class="time-display">00:00:00</div>
        <div id="liveDate" style="font-size: 0.8rem; color: #bdc3c7;">...</div>
    </div>

    <div class="mode-container">
        <button id="btnGuest" class="btn-mode" style="background: #3498db; color: white;">üëÄ Che do Khach</button>
        <button id="btnAdmin" class="btn-mode">üõ°Ô∏è Dang nhap Quan ly</button>
    </div>

    <div class="filter-panel">
        <input type="text" id="searchInput" placeholder="Tim ten hoac lop...">
        <select id="filterClass">
            <option value="all">-- Loc theo lop --</option>
        </select>
        
        <div id="adminTools" class="admin-controls">
            <button class="btn-action bg-dark" id="btnTemplate">üìÑ Tai Mau</button>
            <button class="btn-action bg-green" id="btnImpHS">üì§ Nhap HS</button>
            <button class="btn-action bg-blue" id="btnImpAcc">üîë Nhap Acc</button>
            <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
        </div>

        <button class="btn-action bg-green" id="btnExport" style="margin-left: auto;">üì• Xuat Excel</button>
    </div>

    <div class="stats">
        <div style="text-align:center">TONG HIEN THI<span id="statTotal" class="stat-number" style="color:#f1c40f">0</span></div>
        <div style="text-align:center">CO MAT<span id="statPresent" class="stat-number" style="color:#2ecc71">0</span></div>
        <div style="text-align:center">VANG<span id="statAbsent" class="stat-number" style="color:#e74c3c">0</span></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Lop</th>
                    <th>Ho va Ten</th>
                    <th>Trang Thai</th>
                    <th>Cap nhat</th>
                    <th id="colAction" class="hidden">Thao tac</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="6" style="text-align:center">Dang tai du lieu...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="footer">Phat trien: <strong>Tran Hong Dan</strong> | 2026</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEnDE2pOyfKZYUPCSXgaHaR2b9h_AjAe8",
            authDomain: "hoitrai2026.firebaseapp.com",
            databaseURL: "https://hoitrai2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hoitrai2026",
            storageBucket: "hoitrai2026.firebasestorage.app",
            messagingSenderId: "648028043852",
            appId: "1:648028043852:web:9d0b07f6823fcec5fa12e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let students = [];
        let accounts = {};
        let role = "guest"; 
        let myClass = "";
        let impType = "";

        onValue(ref(db, 'students'), (snap) => {
            students = snap.val() ? Object.values(snap.val()) : [];
            updateFilterClass();
            renderTable();
        });

        onValue(ref(db, 'accounts'), (snap) => {
            accounts = snap.val() || {};
        });

        // DANG NHAP THEO LOGIC MOI
        document.getElementById('btnAdmin').addEventListener('click', () => {
            if (role === "guest") {
                const pass = prompt("Nhap mat khau (Vd: 10a012026 hoac cong8888):");
                if (!pass) return;

                const input = pass.trim().toLowerCase();
                let found = false;

                if (input === "admin123") { role = "admin"; found = true; } 
                else {
                    for (let k in accounts) {
                        const acc = accounts[k];
                        let validPass = "";
                        
                        if (acc.role === "class_manager") {
                            // Ten lop viet thuong + Ma 4 ky tu (Vd: 10a01 + 2026)
                            validPass = acc.targetClass.toLowerCase() + acc.pin;
                        } else if (acc.role === "gate") {
                            // Tu khoa cong + Ma 4 ky tu (Vd: cong + 8888)
                            validPass = "cong" + acc.pin;
                        }

                        if (input === validPass) {
                            role = acc.role;
                            myClass = acc.targetClass || "";
                            found = true; break;
                        }
                    }
                }

                if (found) {
                    alert("‚úÖ Dang nhap thanh cong!");
                    setUIMode();
                } else alert("‚ùå Sai mat khau!");
            } else {
                if (confirm("Dang xuat?")) location.reload();
            }
        });

        function setUIMode() {
            const btn = document.getElementById('btnAdmin');
            btn.innerHTML = role.toUpperCase() + (myClass ? " " + myClass : "");
            btn.classList.add('active-admin');
            document.getElementById('colAction').classList.remove('hidden');
            if (role === "admin") document.getElementById('adminTools').style.display = "flex";
            renderTable();
        }

        const fileInp = document.getElementById('fileInput');
        document.getElementById('btnImpHS').addEventListener('click', () => { impType = "hs"; fileInp.click(); });
        document.getElementById('btnImpAcc').addEventListener('click', () => { impType = "acc"; fileInp.click(); });

        fileInp.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = new Uint8Array(ev.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const updates = {};
                if (impType === "hs") {
                    json.forEach((r, i) => {
                        const id = r.STT || (i + 1);
                        updates['students/' + id] = { id: id, name: r.Ho_Ten, class: String(r.Lop), status: r.Trang_Thai || "present" };
                    });
                } else {
                    json.forEach((r, i) => {
                        // Lay Ma_4_Ky_Tu thay vi Pass co dinh
                        updates['accounts/acc' + i] = { pin: String(r.Ma_4_Ky_Tu), role: r.Quyen, targetClass: String(r.Lop_Target || "") };
                    });
                }
                update(ref(db), updates).then(() => { alert("Import thanh cong!"); fileInp.value = ""; });
            };
            reader.readAsArrayBuffer(file);
        });

        // 3. CAP NHAT FILE MAU THEO DUNG HUONG DAN
        document.getElementById('btnTemplate').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            
            // Sheet Hoc Sinh
            const wsHS = XLSX.utils.json_to_sheet([
                { STT: 1, Ho_Ten: "Nguyen Van An", Lop: "10A01", Trang_Thai: "present" }
            ]);
            XLSX.utils.book_append_sheet(wb, wsHS, "HocSinh");
            
            // Sheet Tai Khoan - DA CAP NHAT COT
            const wsAcc = XLSX.utils.json_to_sheet([
                { 
                    Ghi_Chu: "MK = [Lop_Target thuong] + [Ma_4_Ky_Tu]", 
                    Ma_4_Ky_Tu: "2026", 
                    Quyen: "class_manager", 
                    Lop_Target: "10A01" 
                },
                { 
                    Ghi_Chu: "MK = cong + [Ma_4_Ky_Tu]", 
                    Ma_4_Ky_Tu: "8888", 
                    Quyen: "gate", 
                    Lop_Target: "" 
                }
            ]);
            XLSX.utils.book_append_sheet(wb, wsAcc, "TaiKhoan");
            
            XLSX.writeFile(wb, "Mau_HoiTrai_2026.xlsx");
        });

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const fClass = document.getElementById('filterClass').value;
            tbody.innerHTML = "";
            let sTotal = 0, sPre = 0, sAbs = 0;

            students.sort((a,b) => a.class.localeCompare(b.class)).forEach((s, idx) => {
                const matchClass = (fClass === "all" || s.class === fClass);
                const matchSearch = s.name.toLowerCase().includes(search) || s.class.toLowerCase().includes(search);
                if (matchClass && matchSearch) {
                    sTotal++; s.status === "present" ? sPre++ : sAbs++;
                    const canEdit = (role === "admin" || role === "gate" || (role === "class_manager" && myClass === s.class));
                    const btn = canEdit ? `<button onclick="window.doiSt(${s.id}, '${s.status}')">Doi</button>` : "-";
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${idx+1}</td><td><b>${s.class}</b></td><td>${s.name}</td><td><span class="badge ${s.status === 'present' ? 'bg-present' : 'bg-absent'}">${s.status.toUpperCase()}</span></td><td>${s.lastUpdate || '-'}</td><td class="${role === 'guest' ? 'hidden' : ''}">${btn}</td>`;
                    tbody.appendChild(tr);
                }
            });
            document.getElementById('statTotal').innerText = sTotal;
            document.getElementById('statPresent').innerText = sPre;
            document.getElementById('statAbsent').innerText = sAbs;
        }

        window.doiSt = (id, current) => {
            const newSt = current === "present" ? "absent" : "present";
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes()} - ${now.getDate()}/${now.getMonth()+1}`;
            update(ref(db, 'students/' + id), { status: newSt, lastUpdate: time });
        };

        function updateFilterClass() {
            const select = document.getElementById('filterClass');
            const classes = [...new Set(students.map(s => s.class))].sort();
            if (select.options.length <= 1) {
                classes.forEach(c => { const opt = document.createElement('option'); opt.value = opt.innerText = c; select.appendChild(opt); });
            }
        }

        document.getElementById('searchInput').addEventListener('input', renderTable);
        document.getElementById('filterClass').addEventListener('change', renderTable);
        setInterval(() => {
            const n = new Date();
            document.getElementById('liveTime').innerText = n.toLocaleTimeString('vi-VN');
            document.getElementById('liveDate').innerText = n.toLocaleDateString('vi-VN', {weekday:'long', day:'numeric', month:'long'});
        }, 1000);
    </script>
</body>
</html>

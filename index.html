<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªôi Tr·∫°i Xu√¢n 2026 - THPT S·ªë 1 Tr·∫ßn Ph√∫</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; display: flex; flex-direction: column; min-height: 95vh; }
        
        /* HEADER */
        .school-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .school-name { font-size: 1.2rem; color: #555; font-weight: bold; letter-spacing: 1px; margin: 0; }
        .camp-name { font-size: 2.2rem; color: #d32f2f; font-weight: 900; margin: 5px 0 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }

        /* CLOCK */
        .clock-container { text-align: center; background: #2c3e50; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 20px; width: fit-content; margin-left: auto; margin-right: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .time-display { font-size: 1.5rem; font-weight: bold; font-family: monospace; }
        .date-display { font-size: 0.9rem; color: #bdc3c7; }

        /* MODE SWITCHER */
        .mode-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; background: #e0e0e0; padding: 5px; border-radius: 30px; width: fit-content; margin-left: auto; margin-right: auto; }
        .btn-mode { padding: 10px 25px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; color: #555; background: transparent; }
        .btn-mode.active-guest { background-color: #3498db; color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4); transform: scale(1.05); }
        .btn-mode.active-admin { background-color: #e74c3c; color: white; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4); transform: scale(1.05); }
        .btn-mode:not(.active-guest):not(.active-admin):hover { background-color: rgba(255,255,255,0.5); }

        /* FILTER & EXPORT */
        .filter-panel { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #d32f2f; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-label { font-weight: bold; color: #d32f2f; white-space: nowrap; }
        select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; flex: 1; outline: none; font-size: 1rem; min-width: 150px; }
        .btn-export { background-color: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        /* DATA UPLOAD BUTTON (·∫®n m·∫∑c ƒë·ªãnh) */
        .btn-upload { background-color: #8e44ad; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }

        /* STATS */
        .stats { display: flex; justify-content: space-around; background: #34495e; color: white; padding: 15px; border-radius: 8px; font-weight: bold; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-item { text-align: center; }
        .stat-number { font-size: 1.4rem; display: block; margin-top: 5px; }
        .stat-note { font-size: 0.8rem; font-weight: normal; color: #bdc3c7; display: block; margin-top: 2px;}

        /* TABLE */
        .table-container { flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #d32f2f; color: white; text-transform: uppercase; font-size: 0.9rem; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #fff3e0; }

        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; text-transform: uppercase; display: inline-block; width: 80px; text-align: center; }
        .bg-present { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .bg-absent { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .btn-toggle { background-color: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .hidden { display: none; }

        /* FOOTER */
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #7f8c8d; font-size: 0.9rem; }
        .footer strong { color: #2c3e50; }
        .footer a { color: #d32f2f; text-decoration: none; }
    </style>
</head>
<body>

    <div class="school-header">
        <h3 class="school-name">Tr∆∞·ªùng THPT S·ªë 1 Tr·∫ßn Ph√∫</h3>
        <h1 class="camp-name">H·ªòI TR·∫†I XU√ÇN 2026</h1>
    </div>

    <div class="clock-container">
        <div id="liveTime" class="time-display">00:00:00</div>
        <div id="liveDate" class="date-display">...</div>
    </div>

    <div class="mode-container">
        <button id="btnGuest" class="btn-mode active-guest">üëÄ Ch·∫ø ƒë·ªô Kh√°ch</button>
        <button id="btnAdmin" class="btn-mode">üõ°Ô∏è Ch·∫ø ƒë·ªô Qu·∫£n l√Ω</button>
    </div>

    <div class="filter-panel">
        <span class="filter-label">üîç C√îNG C·ª§:</span>
        <select id="filterClass">
            <option value="all">-- ƒêang t·∫£i d·ªØ li·ªáu... --</option>
        </select>
        <select id="filterStatus">
            <option value="all">-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
            <option value="present">ƒêang c√≥ m·∫∑t</option>
            <option value="absent">ƒêang v·∫Øng</option>
        </select>
        <button class="btn-export" id="btnExport">üì• Xu·∫•t Excel</button>
        <button class="btn-upload" id="btnUploadData">‚¨ÜÔ∏è N·∫°p D·ªØ Li·ªáu G·ªëc</button>
    </div>

    <div class="stats">
        <div class="stat-item">
            <span>T·ªîNG S·ªê</span><span class="stat-note">(L·ªõp ƒëang ch·ªçn)</span>
            <span id="statTotal" class="stat-number" style="color: #f1c40f;">...</span>
        </div>
        <div class="stat-item">
            <span>C√ì M·∫∂T</span><span class="stat-note">(Th·ª±c t·∫ø)</span>
            <span id="statPresent" class="stat-number" style="color: #2ecc71;">...</span>
        </div>
        <div class="stat-item">
            <span>V·∫ÆNG</span><span class="stat-note">(Th·ª±c t·∫ø)</span>
            <span id="statAbsent" class="stat-number" style="color: #ff6b6b;">...</span>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">STT</th>
                    <th style="width: 100px;">L·ªõp</th>
                    <th>H·ªç v√† T√™n</th>
                    <th style="width: 120px;">Tr·∫°ng Th√°i</th>
                    <th style="width: 100px;" id="colAction" class="hidden">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" style="text-align:center; padding: 20px;">ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß Firebase (hoitrai2026)...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="footer">
        ¬© 2026 Ph√°t tri·ªÉn b·ªüi: <strong>Tr·∫ßn H·ªìng D√¢n</strong><br>
        Email: <a href="mailto:tranhongdan@tranphudlk.edu.vn">tranhongdan@tranphudlk.edu.vn</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ============================================================
        // 1. C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N (ƒê√£ c·∫≠p nh·∫≠t)
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyDEnDE2pOyfKZYUPCSXgaHaR2b9h_AjAe8",
          authDomain: "hoitrai2026.firebaseapp.com",
          databaseURL: "https://hoitrai2026-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "hoitrai2026",
          storageBucket: "hoitrai2026.firebasestorage.app",
          messagingSenderId: "648028043852",
          appId: "1:648028043852:web:9d0b07f6823fcec5fa12e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ============================================================
        // 2. D·ªÆ LI·ªÜU G·ªêC (Thay n·ªôi dung Excel c·ªßa b·∫°n v√†o ƒë√¢y)
        // ============================================================
        const initialStudentsData = [
            { id: 1, name: "NGUY·ªÑN T·∫§N HO√ÄNG ANH", class: "10A01", status: "present" },
            { id: 2, name: "NGUY·ªÑN TU·∫§N ANH", class: "10A01", status: "present" },
            { id: 3, name: "MAI TH√ÅI B·∫¢O", class: "10A01", status: "present" },
            { id: 4, name: "TH√ÇN VƒÇN B·∫¢O", class: "10A01", status: "present" },
            { id: 5, name: "HO√ÄNG NG·ªåC B·∫¢O CH√ÇU", class: "10A01", status: "present" },
            { id: 6, name: "L√ä NG·ªåC DI·ªÜP", class: "10A01", status: "present" },
            { id: 7, name: "HU·ª≤NH ƒê√ÄM B√åNH D∆Ø∆†NG", class: "10A01", status: "present" }
            // ... B·∫°n h√£y d√πng code VBA ·ªü c√°c b∆∞·ªõc tr∆∞·ªõc ƒë·ªÉ t·∫°o danh s√°ch ƒë·∫ßy ƒë·ªß ...
        ];

        // ============================================================
        // 3. LOGIC X·ª¨ L√ù
        // ============================================================
        let globalStudents = []; 
        let isAdmin = false;
        const SYSTEM_PASSWORD = "123";

        // L·∫Øng nghe d·ªØ li·ªáu
        const starCountRef = ref(db, 'students');
        onValue(starCountRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                globalStudents = Object.values(data); 
                renderTable();
                initFilter();
                document.getElementById('btnUploadData').style.display = 'none';
            } else {
                globalStudents = [];
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">H·ªá th·ªëng ch∆∞a c√≥ d·ªØ li·ªáu! Vui l√≤ng ƒêƒÉng nh·∫≠p qu·∫£n l√Ω ƒë·ªÉ n·∫°p d·ªØ li·ªáu.</td></tr>';
                document.getElementById('statTotal').textContent = "0";
                if(isAdmin) document.getElementById('btnUploadData').style.display = 'inline-block';
            }
        });

        window.toggleStatus = function(id) {
            const student = globalStudents.find(s => s.id === id);
            if (student) {
                const newStatus = (student.status === 'present') ? 'absent' : 'present';
                update(ref(db, 'students/' + id), { status: newStatus });
            }
        };

        window.uploadInitialData = function() {
            if(confirm("B·∫°n mu·ªën n·∫°p to√†n b·ªô danh s√°ch h·ªçc sinh l√™n Firebase?")) {
                const updates = {};
                initialStudentsData.forEach(s => {
                    updates['students/' + s.id] = s;
                });
                update(ref(db), updates)
                .then(() => alert("ƒê√£ n·∫°p d·ªØ li·ªáu th√†nh c√¥ng!"))
                .catch((error) => alert("L·ªói k·∫øt n·ªëi Firebase: " + error));
            }
        }

        function renderTable() {
            const tbody = document.getElementById("tableBody");
            const fClass = document.getElementById("filterClass").value;
            const fStatus = document.getElementById("filterStatus").value;

            tbody.innerHTML = "";
            let statTotal = 0, statPresent = 0, statAbsent = 0;
            let displayCount = 0;

            const sortedStudents = [...globalStudents].sort((a, b) => a.class.localeCompare(b.class));

            sortedStudents.forEach((s) => {
                let isClassMatch = (fClass === 'all' || s.class === fClass);
                if (isClassMatch) {
                    statTotal++;
                    s.status === 'present' ? statPresent++ : statAbsent++;
                }

                let isStatusMatch = (fStatus === 'all' || s.status === fStatus);
                if (isClassMatch && isStatusMatch) {
                    displayCount++;
                    const badge = s.status === 'present' 
                        ? `<span class="badge bg-present">C√ì M·∫∂T</span>` 
                        : `<span class="badge bg-absent">V·∫ÆNG</span>`;
                    
                    const actionBtn = `<button class="btn-toggle" onclick="toggleStatus(${s.id})">ƒê·ªïi</button>`;
                    
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${displayCount}</td>
                        <td><strong>${s.class}</strong></td>
                        <td>${s.name}</td>
                        <td>${badge}</td>
                        ${isAdmin ? `<td>${actionBtn}</td>` : `<td class="hidden"></td>`}
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.getElementById("statTotal").textContent = statTotal;
            document.getElementById("statPresent").textContent = statPresent;
            document.getElementById("statAbsent").textContent = statAbsent;
        }

        function initFilter() {
            const select = document.getElementById("filterClass");
            const uniqueClasses = [...new Set(globalStudents.map(s => s.class))].sort();
            
            if (select.options.length <= 1 && uniqueClasses.length > 0) {
                 select.innerHTML = '<option value="all">-- T·∫•t c·∫£ c√°c l·ªõp --</option>';
                 uniqueClasses.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
            }
        }

        // --- EVENTS ---
        document.getElementById('btnGuest').addEventListener('click', () => { isAdmin = false; updateUIMode(); });
        document.getElementById('btnAdmin').addEventListener('click', () => {
            if (!isAdmin) {
                const pass = prompt("üîë Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã:");
                if (pass === SYSTEM_PASSWORD) { isAdmin = true; updateUIMode(); } 
                else if (pass !== null) alert("‚ùå Sai m·∫≠t kh·∫©u!");
            }
        });

        function updateUIMode() {
            const btnGuest = document.getElementById("btnGuest");
            const btnAdmin = document.getElementById("btnAdmin");
            const colAction = document.getElementById("colAction");
            const btnUpload = document.getElementById("btnUploadData");

            if(isAdmin) {
                btnGuest.classList.remove("active-guest");
                btnAdmin.classList.add("active-admin");
                colAction.classList.remove("hidden");
                if(globalStudents.length === 0) btnUpload.style.display = 'inline-block';
            } else {
                btnGuest.classList.add("active-guest");
                btnAdmin.classList.remove("active-admin");
                colAction.classList.add("hidden");
                btnUpload.style.display = 'none';
            }
            renderTable();
        }

        document.getElementById('filterClass').addEventListener('change', renderTable);
        document.getElementById('filterStatus').addEventListener('change', renderTable);
        document.getElementById('btnUploadData').addEventListener('click', window.uploadInitialData);
        
        document.getElementById('btnExport').addEventListener('click', () => {
            const now = new Date();
            const timeStr = now.toLocaleString('vi-VN');
            const fClass = document.getElementById("filterClass").value;
            const fStatus = document.getElementById("filterStatus").value;
            
            let html = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta charset="UTF-8"></head>
                <body>
                    <h2 style="text-align:center">TR∆Ø·ªúNG THPT S·ªê 1 TR·∫¶N PH√ö - H·ªòI TR·∫†I XU√ÇN 2026</h2>
                    <p style="text-align:center"><i>Th·ªùi gian xu·∫•t b√°o c√°o: ${timeStr}</i></p>
                    <p style="text-align:center"><i>Ng∆∞·ªùi xu·∫•t b√°o c√°o: Tr·∫ßn H·ªìng D√¢n</i></p>
                    <table border="1" style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr style="background-color: #d32f2f; color: white;">
                                <th>STT</th>
                                <th>L·ªõp</th>
                                <th>H·ªç v√† T√™n</th>
                                <th>Tr·∫°ng Th√°i</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            let count = 0;
            const sortedStudents = [...globalStudents].sort((a, b) => a.class.localeCompare(b.class));
            sortedStudents.forEach(s => {
                let isClassMatch = (fClass === 'all' || s.class === fClass);
                let isStatusMatch = (fStatus === 'all' || s.status === fStatus);
                if (isClassMatch && isStatusMatch) {
                    count++;
                    const statusText = s.status === 'present' ? 'C√≥ m·∫∑t' : 'V·∫Øng';
                    const color = s.status === 'present' ? 'green' : 'red';
                    html += `<tr><td style="text-align:center">${count}</td><td style="text-align:center"><b>${s.class}</b></td><td>${s.name}</td><td style="color:${color}; font-weight:bold; text-align:center">${statusText}</td></tr>`;
                }
            });
            html += `</tbody></table><br><p style="text-align:right">X√°c nh·∫≠n c·ªßa BTC</p></body></html>`;
            const blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Danh_Sach_Trai_Sinh_${now.getTime()}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        function updateClock() {
            const now = new Date();
            document.getElementById('liveTime').textContent = now.toLocaleTimeString('vi-VN');
            document.getElementById('liveDate').textContent = now.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
